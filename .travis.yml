language: cpp

before_script:
  - mkdir build
  - cd build

matrix:
  include:

  #
  # Clang Tidy
  #
  - os: linux
    name: Clang Tidy
    env:
      - TEST="Clang Tidy"
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
          - llvm-toolchain-trusty-4.0
        packages:
          - clang-4.0
          - clang-tidy-4.0
          - gcc-6
          - g++-6
    script:
      - cmake -DENABLE_CLANG_TIDY=ON -DCMAKE_CXX_COMPILER="g++-6" ..
      - make
      - make tidy > output.txt
      - |
        if [[ -n $(grep "warning: " output.txt) ]] || [[ -n $(grep "error: " output.txt) ]]; then
            echo "You must pass the clang tidy checks before submitting a pull request"
            echo ""
            grep --color -E '^|warning: |error: ' output.txt
            exit -1;
        else
            echo -e "\033[1;32m\xE2\x9C\x93 passed:\033[0m $1";
        fi

    #
    # Coveralls
    #
  - os: linux
    name: Linux Release + Coverage
    env:
      - TEST="Coveralls"
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gcc-6
          - g++-6
    script:
      - pip install --upgrade --user git+git://github.com/eddyxu/cpp-coveralls.git
      - cmake -DENABLE_COVERAGE=ON -DCMAKE_CXX_COMPILER="g++-6" ..
      - cmake --build .
      - ./gfunction_tests
      - coveralls --build-root build --gcov-options '\-lp' \
            -e build/third_party

    #
    # Mac
    #
  - os: osx
    name: Mac Release
    script:
      - cmake ..
      - cmake --build .
      - ./gfunction_tests

    #
    # Windows
    #
  - os: windows
    name: Windows Release
    script:
      - cmake ..
      - cmake --build .
      - ./Debug/gfunction_tests.exe
